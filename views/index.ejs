<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock with - æ ªå¼æŠ•è³‡å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Clerkèªè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        window.Clerk = window.Clerk || {};
        window.Clerk.publishableKey = '<%= publishableKey || "" %>';
    </script>
    <% if (publishableKey) { %>
    <script async crossorigin="anonymous" data-clerk-publishable-key="<%= publishableKey %>" src="https://<%= publishableKey.split('_')[1] %>.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
    <% } %>
</head>
<body>

    <style>
        /* General body style for demonstration */
        body {
            margin: 0;
            font-family: sans-serif;
        }

        .container {
            width: 100%;
            max-width: 1200px; /* Or your desired max width */
            margin: 0 auto;
            box-sizing: border-box; /* Ensures padding doesn't add to width */
        }

        /* --- ã“ã“ã‹ã‚‰ãŒãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã§ã™ --- */

        .site-header {
            padding: 10px 0;
            min-height: auto;
            border-bottom: 1px solid #f0f0f0; /* Optional: adds a nice separator */
        }

        .header-content {
            display: flex;
            justify-content: center; /* ä¸­å¤®æƒãˆã«å¤‰æ›´ */
            align-items: center;
            flex-wrap: nowrap; 
            padding: 0 15px;
            position: relative; /* ç›¸å¯¾ä½ç½®æŒ‡å®šã§å·¦å³ã®è¦ç´ ã‚’çµ¶å¯¾é…ç½® */
        }

        /* å·¦å´ã®ã‚¹ãƒšãƒ¼ã‚µãƒ¼ï¼ˆéè¡¨ç¤ºï¼‰ */
        .header-spacer {
            display: none; /* å·¦å´ã‚¹ãƒšãƒ¼ã‚µãƒ¼ã¯ä¸è¦ãªã®ã§éè¡¨ç¤º */
        }
        
        /* å³å´ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .header-actions {
            position: absolute; /* çµ¶å¯¾é…ç½® */
            right: 15px; /* å³ç«¯ã‹ã‚‰15px */
            top: 50%; /* å‚ç›´ä¸­å¤® */
            transform: translateY(-50%); /* ä¸­å¤®æƒãˆ */
        }

        .site-title {
            flex-grow: 0;  /* ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŸ‹ã‚ãªã„ */
            flex-shrink: 0; /* ç¸®ã¾ãªã„ */
            margin: 0;
            font-size: 1.5rem;
            text-align: center;
            /* ã‚¿ã‚¤ãƒˆãƒ«ãŒå®Ÿéš›ã«å¿…è¦ãªå¹…ã ã‘ã‚’å–ã‚‹ */
            width: auto;
            max-width: calc(100% - 120px); /* å·¦å³ã®ãƒœã‚¿ãƒ³åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
        }

        .site-title a {
            text-decoration: none;
            color: inherit;
        }

        #login-btn {
            border: none;
            background: none;
            padding: 8px 12px;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .user-greeting {
            margin-right: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        /* --- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ --- */
        
        /* 768pxä»¥ä¸‹ã®ç”»é¢ã‚µã‚¤ã‚º */
        @media (max-width: 768px) {
            .site-title {
                font-size: 1.2rem;
            }
            #login-btn {
                padding: 6px 8px;
                font-size: 1rem;
            }
            /* [ä¿®æ­£ç‚¹3] ãƒ¢ãƒã‚¤ãƒ«ã§ã¯å·¦å³ã®ä½™ç™½ã‚’å°‘ã—ç‹­ãã—ã¦ã€ã‚¿ã‚¤ãƒˆãƒ«ç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ã—ã¾ã™ */
            .header-spacer,
            .header-actions {
                width: 44px; 
            }
        }

        /* 480pxä»¥ä¸‹ã®ç”»é¢ã‚µã‚¤ã‚º */
        @media (max-width: 480px) {
            .header-content {
                padding: 0 10px; /* ã•ã‚‰ã«ç‹­ã„ç”»é¢ã§ã¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°‘ã—æ¸›ã‚‰ã™ */
            }
            .site-title {
                font-size: 1.1rem;
            }
            .header-spacer,
            .header-actions {
                width: 40px; /* ã•ã‚‰ã«ä½™ç™½ã‚’ç‹­ãã™ã‚‹ */
            }
        }
    </style>

    <header class="site-header">
        <div class="container">
            <!-- ä¿®æ­£å¾Œã®HTMLæ§‹é€  -->
            <div class="header-content">
                <!-- å·¦å´ã®ã‚¹ãƒšãƒ¼ã‚µãƒ¼ -->
                <div class="header-spacer"></div>

                <!-- ã‚µã‚¤ãƒˆã‚¿ã‚¤ãƒˆãƒ« -->
                <h1 class="site-title">
                    <a href="/learning" class="home-link">Stock with</a>
                </h1>
                
                <!-- å³å´ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="header-actions">
                    <% if (user) { %>
                        <!-- ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆ -->
                        <span id="user-greeting" class="user-greeting">
                            ã“ã‚“ã«ã¡ã¯ã€<span id="user-name"><%= user.firstName || user.emailAddresses[0]?.emailAddress || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' %></span>ã•ã‚“
                        </span>
                        <button id="logout-btn" class="btn btn-outline" onclick="window.Clerk.signOut()">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                        <button id="login-btn" class="btn btn-outline" onclick="window.Clerk.openUserProfile()">
                            <i class="fas fa-user"></i>
                        </button>
                    <% } else { %>
                        <!-- æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ -->
                        <span id="user-greeting" style="display: none;"></span>
                        <button id="logout-btn" class="btn btn-outline" onclick="window.Clerk.signOut()" style="display: none;">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                        <button id="login-btn" class="btn btn-outline" onclick="window.Clerk.openSignIn()">
                            <i class="fas fa-right-to-bracket"></i>
                        </button>
                    <% } %>
                </div>
            </div>
        </div>
    </header>

    <main class="site-main">
        <div class="container">
            <% if (isGuest) { %>
            <!-- ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰é€šçŸ¥ -->
            <div class="guest-notice">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å­¦ç¿’ä¸­</strong><br>
                    å­¦ç¿’é€²æ—ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚é€²æ—ã‚’ä¿å­˜ã™ã‚‹ã«ã¯<a href="#" onclick="window.Clerk.openSignIn()">ãƒ­ã‚°ã‚¤ãƒ³</a>ã¾ãŸã¯<a href="#" onclick="window.Clerk.openSignUp()">æ–°è¦ç™»éŒ²</a>ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
            <% } %>
            
            <!-- æ¤œç´¢æ©Ÿèƒ½ -->
            <div id="search-container">
                <!-- æ¤œç´¢ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿è¡¨ç¤ºï¼ˆåˆæœŸçŠ¶æ…‹ï¼‰ -->
                <div id="search-indicator" class="search-indicator">
                    <div class="search-icon">ğŸ”</div>
                    <div class="search-text">æ¤œç´¢</div>
                </div>
                
                <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼‰ -->
                <div class="search-form-container hidden">
                    <form action="/search" method="GET" class="search-form">
                        <input type="search" name="q" class="search-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ (ä¾‹: NISA, åˆ†æ)">
                        <button type="button" class="btn search-btn" id="search-button">æ¤œç´¢</button>
                    </form>
                </div>
            </div>

            <!-- å­¦ç¿’é€²æ—ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ -->
            <div id="stepper-container">
                <!-- é€²æ—ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿è¡¨ç¤ºï¼ˆåˆæœŸçŠ¶æ…‹ï¼‰ -->
                <div id="progress-indicator" class="progress-indicator">
                    <div class="progress-icon">ğŸ‘£</div>
                    <div class="progress-text">é€²æ—</div>
                </div>
                
                <!-- ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼å…¨ä½“ï¼ˆåˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼‰ -->
                <div class="stepper hidden">
                    <% chapters.forEach((chapter, index) => { %>
                        <div class="stepper-item" data-chapter="<%= index %>">
                            <div class="stepper-indicator clickable" data-chapter="<%= index %>"><%= index + 1 %></div>
                            <div class="stepper-title">Stage<%= chapter.chapter %></div>
                            <div class="stepper-description"><%= chapter.title %></div>
                        </div>
                    <% }); %>
                </div>
            </div>

            <% chapters.forEach((chapter, index) => { %>
                <section class="chapter" data-chapter="<%= index %>">
                    <div class="chapter-header">
                        <div class="chapter-title-container">
                            <button class="chapter-toggle" data-chapter="<%= index %>" aria-expanded="<%= index === 0 ? 'true' : 'false' %>">
                                <h2>Stage<%= chapter.chapter %>: <%= chapter.title %></h2>
                            </button>
                        </div>
                        <% if (chapter.totalQuestions > 0) { %>
                            <div class="progress-container">
                                <div class="progress-bar" data-width="<%= Math.round(chapter.progressPercentage) %>"></div>
                                <span class="progress-text"><%= chapter.clearedQuestions %> / <%= chapter.totalQuestions %> å•ã‚¯ãƒªã‚¢</span>
                            </div>
                        <% } %>
                    </div>
                    <div class="chapter-content" id="chapter-<%= index %>" data-visible="<%= index === 0 ? 'true' : 'false' %>">
                        <ul class="lesson-list">
                            <% chapter.lessons.forEach(lesson => { %>
                                <li><a href="/lessons/<%= lesson.id %>"><%= lesson.title %></a></li>
                            <% }); %>
                        </ul>
                    </div>
                </section>
            <% }); %>
        </div>
    </main>

    <div class="admin-link-container" style="text-align: center; margin: 20px 0;">
        <a href="/admin/lessons/new" class="btn">ï¼‹ æ–°è¦ãƒ¬ãƒƒã‚¹ãƒ³ã‚’ä½œæˆã™ã‚‹</a>
    </div>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2024 Stock withæ ªå¼ä¼šç¤¾. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆæ©Ÿèƒ½ï¼ˆä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰ -->
    <!-- <%- include('_chatbot') %> -->
    <!-- <script src="/chatbot.js"></script> -->
    <script>
        // Clerkã®åˆæœŸåŒ–ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ç®¡ç†
        window.addEventListener('load', async () => {
            try {
                await window.Clerk.load();
                console.log('Clerk loaded successfully');
                updateAuthUI();
                
                // Clerkã®åˆæœŸåŒ–å®Œäº†å¾Œã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                window.Clerk.addListener(({ user }) => {
                    updateAuthUI();
                });
            } catch (error) {
                console.error('Error loading Clerk:', error);
                // Clerkã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸå ´åˆã¯ã€ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        });
        
        // èªè¨¼UIã®æ›´æ–°é–¢æ•°ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§æ—¢ã«é©åˆ‡ãªçŠ¶æ…‹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç°¡ç´ åŒ–ï¼‰
        function updateAuthUI() {
            const user = window.Clerk.user;
            const userGreeting = document.getElementById('user-greeting');
            const logoutBtn = document.getElementById('logout-btn');
            const loginBtn = document.getElementById('login-btn');
            
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆ
                if (userGreeting) {
                    userGreeting.style.display = 'inline';
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æ›´æ–°
                    const userName = document.getElementById('user-name');
                    if (userName) {
                        userName.textContent = user.firstName || user.emailAddresses[0]?.emailAddress || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                    }
                }
                if (logoutBtn) logoutBtn.style.display = 'inline-block';
                if (loginBtn) {
                    loginBtn.innerHTML = '<i class="fas fa-user"></i>';
                    loginBtn.onclick = () => window.Clerk.openUserProfile();
                }
            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ
                if (userGreeting) userGreeting.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (loginBtn) {
                    loginBtn.innerHTML = '<i class="fas fa-right-to-bracket"></i>';
                    loginBtn.onclick = () => window.Clerk.openSignIn();
                }
            }
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ©Ÿèƒ½ã¨æ¤œç´¢æ©Ÿèƒ½ã®JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®å¹…ã‚’è¨­å®š
            document.querySelectorAll('.progress-bar').forEach(bar => {
                const width = bar.getAttribute('data-width');
                if (width) {
                    bar.style.width = width + '%';
                }
            });
            
            // ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’è¨­å®š
            document.querySelectorAll('.chapter-content').forEach(content => {
                const visible = content.getAttribute('data-visible');
                if (visible === 'true') {
                    content.style.display = 'block';
                } else {
                    content.style.display = 'none';
                }
            });
            
            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ©Ÿèƒ½
            const chapterToggles = document.querySelectorAll('.chapter-toggle');
            
            chapterToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    console.log('Chapter toggle clicked!');
                    const chapterIndex = this.getAttribute('data-chapter');
                    const chapterContent = document.getElementById(`chapter-${chapterIndex}`);
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';
                    
                    console.log('Chapter index:', chapterIndex);
                    console.log('Chapter content element:', chapterContent);
                    console.log('Is expanded:', isExpanded);
                    
                    if (isExpanded) {
                        // é–‰ã˜ã‚‹
                        chapterContent.style.display = 'none';
                        this.setAttribute('aria-expanded', 'false');
                        console.log('Chapter closed');
                    } else {
                        // é–‹ã
                        chapterContent.style.display = 'block';
                        this.setAttribute('aria-expanded', 'true');
                        console.log('Chapter opened');
                    }
                });
            });

            // é€²æ—ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆStepperã®è¡¨ç¤º/éè¡¨ç¤ºï¼‰
            const progressIndicator = document.getElementById('progress-indicator');
            const stepperContainer = document.getElementById('stepper-container');
            const stepper = document.querySelector('.stepper');
            
            progressIndicator.addEventListener('click', function() {
                console.log('Progress indicator clicked!');
                
                if (stepper.classList.contains('hidden')) {
                    // Stepperã‚’è¡¨ç¤º
                    stepper.classList.remove('hidden');
                    stepperContainer.classList.add('active');
                    console.log('Stepper displayed');
                } else {
                    // Stepperã‚’éè¡¨ç¤º
                    stepper.classList.add('hidden');
                    stepperContainer.classList.remove('active');
                    console.log('Stepper hidden');
                }
            });
            
            // æ¤œç´¢ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º/éè¡¨ç¤ºï¼‰
            const searchIndicator = document.getElementById('search-indicator');
            const searchFormContainer = document.querySelector('.search-form-container');
            
            searchIndicator.addEventListener('click', function() {
                console.log('Search indicator clicked!');
                
                if (searchFormContainer.classList.contains('hidden')) {
                    // æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                    searchFormContainer.classList.remove('hidden');
                    console.log('Search form displayed');
                } else {
                    // æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
                    searchFormContainer.classList.add('hidden');
                    console.log('Search form hidden');
                }
            });
            
            // ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
            const stepperIndicators = document.querySelectorAll('.stepper-indicator.clickable');
            
            stepperIndicators.forEach(indicator => {
                indicator.addEventListener('click', function() {
                    console.log('Stepper indicator clicked!');
                    const chapterIndex = this.getAttribute('data-chapter');
                    console.log('Chapter index:', chapterIndex);
                    
                    const targetChapter = document.querySelector(`section.chapter[data-chapter="${chapterIndex}"]`);
                    console.log('Target chapter found:', targetChapter);
                    
                    if (targetChapter) {
                        // å¯¾å¿œã™ã‚‹Chapterã‚’é–‹ã
                        const chapterToggle = targetChapter.querySelector('.chapter-toggle');
                        const chapterContent = targetChapter.querySelector('.chapter-content');
                        
                        if (chapterToggle && chapterContent) {
                            // ChapterãŒé–‰ã˜ã¦ã„ã‚‹å ´åˆã¯é–‹ã
                            if (chapterContent.style.display === 'none') {
                                chapterContent.style.display = 'block';
                                chapterToggle.setAttribute('aria-expanded', 'true');
                                console.log('Chapter opened');
                            }
                        }
                        
                        // ç”»é¢ä¸­å¤®ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆã‚ˆã‚Šæ­£ç¢ºãªä½ç½®è¨ˆç®—ï¼‰
                        const targetRect = targetChapter.getBoundingClientRect();
                        const windowHeight = window.innerHeight;
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        const targetTop = targetRect.top + scrollTop;
                        const offset = (windowHeight - targetRect.height) / 2;
                        
                        console.log('Scroll calculation:', {
                            targetRect: targetRect,
                            windowHeight: windowHeight,
                            scrollTop: scrollTop,
                            targetTop: targetTop,
                            offset: offset
                        });
                        
                        window.scrollTo({
                            top: targetTop - offset,
                            behavior: 'smooth'
                        });
                        
                        console.log('Scrolling to:', targetTop - offset);
                    } else {
                        console.log('Target chapter not found!');
                    }
                });
            });

            // æ¤œç´¢æ©Ÿèƒ½ã®æ”¹å–„
            const searchForm = document.querySelector('.search-form');
            const searchBtn = document.getElementById('search-button');
            const searchInput = document.querySelector('.search-input');

            console.log('Search elements found:', { searchForm, searchBtn, searchInput });

            // æ¤œç´¢ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            if (searchBtn) {
                searchBtn.addEventListener('click', function(e) {
                    console.log('Search button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    const query = searchInput.value.trim();
                    console.log('Search query:', query);
                    if (query) {
                        window.location.href = `/search?q=${encodeURIComponent(query)}`;
                    }
                });
            }

            // Enterã‚­ãƒ¼ã§ã®æ¤œç´¢ï¼ˆæ—¢å­˜ã®å‹•ä½œã‚’ä¿æŒï¼‰
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    console.log('Search form submitted');
                    e.preventDefault();
                    const query = searchInput.value.trim();
                    console.log('Search query:', query);
                    if (query) {
                        window.location.href = `/search?q=${encodeURIComponent(query)}`;
                    }
                });
            }

            // ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ã®çŠ¶æ…‹æ›´æ–°
            function updateStepperProgress() {
                const stepperItems = document.querySelectorAll('.stepper-item');
                const chapterElements = document.querySelectorAll('.chapter');
                
                // ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ã®çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆãƒ‡ãƒ¼ã‚¿å±æ€§ã‚’ä½¿ç”¨ï¼‰
                stepperItems.forEach((item) => {
                    const chapterIndex = parseInt(item.getAttribute('data-chapter'));
                    item.classList.remove('active', 'completed');
                    
                    // å¯¾å¿œã™ã‚‹Chapterã®é€²æ—çŠ¶æ³ã‚’ç¢ºèª
                    const chapter = chapterElements[chapterIndex];
                    if (chapter) {
                        const progressText = chapter.querySelector('.progress-text');
                        if (progressText) {
                            const match = progressText.textContent.match(/(\d+) \/ (\d+) å•ã‚¯ãƒªã‚¢/);
                            if (match) {
                                const clearedQuestions = parseInt(match[1]);
                                const totalQuestions = parseInt(match[2]);
                                if (totalQuestions > 0 && clearedQuestions === totalQuestions) {
                                    // å…¨å•ã‚¯ãƒªã‚¢ã—ãŸå ´åˆã®ã¿é’è‰²ï¼ˆcompletedï¼‰ã§è¡¨ç¤º
                                    item.classList.add('completed');
                                    console.log(`Chapter ${chapterIndex + 1}: completed`);
                                } else {
                                    // æœªå®Œäº†ã®å ´åˆã¯ã‚°ãƒ¬ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã§è¡¨ç¤º
                                    console.log(`Chapter ${chapterIndex + 1}: incomplete`);
                                }
                            } else {
                                // é€²æ—æƒ…å ±ãŒãªã„å ´åˆã‚‚ã‚°ãƒ¬ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã§è¡¨ç¤º
                                console.log(`Chapter ${chapterIndex + 1}: no progress info`);
                            }
                        } else {
                            // é€²æ—è¡¨ç¤ºãŒãªã„å ´åˆã‚‚ã‚°ãƒ¬ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã§è¡¨ç¤º
                            console.log(`Chapter ${chapterIndex + 1}: no progress display`);
                        }
                    }
                });
                
                // ç·šã®è‰²ã‚’æ›´æ–°ï¼ˆä¸¡å´ã®Chapterã‚¢ã‚¤ã‚³ãƒ³ãŒé’ã®æ™‚ã®ã¿ç·šã‚’é’ãã™ã‚‹ï¼‰
                updateStepperLines();
            }
            
            // ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ã®ç·šã®è‰²ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
            function updateStepperLines() {
                const stepperItems = document.querySelectorAll('.stepper-item');
                
                stepperItems.forEach((item, index) => {
                    if (index < stepperItems.length - 1) { // æœ€å¾Œã®ã‚¢ã‚¤ãƒ†ãƒ ä»¥å¤–
                        const currentItem = item;
                        const nextItem = stepperItems[index + 1];
                        
                        // ä¸¡å´ã®Chapterã‚¢ã‚¤ã‚³ãƒ³ãŒé’ï¼ˆcompletedï¼‰ã®å ´åˆã®ã¿ç·šã‚’é’ãã™ã‚‹
                        if (currentItem.classList.contains('completed') && nextItem.classList.contains('completed')) {
                            currentItem.style.setProperty('--line-color', 'var(--primary-color)');
                        } else {
                            currentItem.style.setProperty('--line-color', 'var(--border-color)');
                        }
                    }
                });
            }

            // åˆæœŸåŒ–æ™‚ã«ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ã®çŠ¶æ…‹ã‚’æ›´æ–°
            updateStepperProgress();

            // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šæ¤œç´¢ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            setTimeout(() => {
                console.log('Search button element:', document.querySelector('.search-btn'));
                console.log('Search button text:', document.querySelector('.search-btn')?.textContent);
                console.log('Search button visible:', document.querySelector('.search-btn')?.offsetParent !== null);
            }, 1000);
        });
    </script>
</body>
</html>