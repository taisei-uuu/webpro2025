<!DOCTYPE html>
<html lang="ja">

<head>
    <%- include('../partials/analytics') %>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>
            <%= article.title %> - Stock with
        </title>
        <link rel="icon" type="image/png" href="/logo.png">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/style.css">
        <link rel="stylesheet" href="/navbar.css">

        <!-- Clerk認証スクリプト -->
        <script>
            window.Clerk = window.Clerk || {};
            window.Clerk.publishableKey = '<%= publishableKey || "" %>';
        </script>
        <% if (publishableKey) { %>
            <script async crossorigin="anonymous" data-clerk-publishable-key="<%= publishableKey %>"
                src="https://<%= publishableKey.split('_')[1] %>.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
            <% } %>
</head>

<body>
    <%- include('../partials/header') %>

        <main class="site-main">
            <div class="container">
                <%- include('../partials/navigation', { path: '/articles' }) %>

                    <article class="article-container">
                        <header class="article-header">
                            <h1 class="article-title">
                                <%= article.title %>
                            </h1>
                            <div class="article-meta-row">
                                <div class="article-date">
                                    <i class="fas fa-calendar-alt"></i>
                                    <%= new Date(article.publishedAt).toLocaleDateString('ja-JP') %>
                                </div>
                                <!-- <button class="like-button <%= likes.hasLiked ? 'active' : '' %>"
                                    onclick="toggleLike('<%= article.id %>')">
                                    <i class="<%= likes.hasLiked ? 'fas' : 'far' %> fa-heart"></i>
                                    <span class="like-count">
                                        <%= likes.count %>
                                    </span>
                                </button> -->
                            </div>
                        </header>

                        <div class="article-content">
                            <% if (article.thumbnail) { %>
                                <div class="article-main-image">
                                    <img src="<%= article.thumbnail.url %>" alt="<%= article.title %>">
                                </div>
                                <% } %>

                                    <div class="article-introduction">
                                        <%- article.introduction %>
                                    </div>

                                    <% if (article.body) { %>
                                        <div class="article-body">
                                            <%- article.body %>
                                        </div>
                                        <% } else if (article.isPaid) { %>
                                            <div class="paywall-container">
                                                <div class="paywall-overlay"></div>
                                                <div class="paywall-content">
                                                    <div class="lock-icon">
                                                        <i class="fas fa-lock"></i>
                                                    </div>
                                                    <h3>この続きは有料コンテンツです</h3>
                                                    <p>記事を購入するか、プレミアムプランに加入してお楽しみください。</p>

                                                    <div class="paywall-actions">
                                                        <% if (isGuest) { %>
                                                            <div class="alert alert-info mb-3">
                                                                <i class="fas fa-info-circle me-2"></i>
                                                                有料記事の閲覧や購入には、無料の会員登録が必要です。
                                                            </div>
                                                            <button
                                                                onclick="window.Clerk.openSignIn({ redirectUrl: window.location.href })"
                                                                class="btn btn-primary btn-lg w-100 mb-3">
                                                                <i class="fas fa-right-to-bracket me-2"></i>
                                                                ログイン / 新規登録して続きを読む
                                                            </button>
                                                            <% } else { %>
                                                                <% if (article.price) { %>
                                                                    <button id="purchase-btn" class="btn btn-purchase"
                                                                        data-article-id="<%= article.id %>"
                                                                        data-price="<%= article.price %>"
                                                                        data-title="<%= article.title %>">
                                                                        <i class="fas fa-shopping-cart"></i>
                                                                        記事を購入する (¥<%= article.price %>)
                                                                    </button>
                                                                    <div class="divider">または</div>
                                                                    <% } %>

                                                                        <a href="/subscription?return_url=<%= encodeURIComponent('/articles/' + article.id) %>"
                                                                            class="btn btn-subscribe-link">
                                                                            <i class="fas fa-crown"></i>
                                                                            プレミアムプランで読み放題 (¥500/月)
                                                                        </a>
                                                                        <% } %>
                                                    </div>
                                                </div>
                                            </div>

                                            <style>
                                                .paywall-container {
                                                    background: #f8fafc;
                                                    border: 1px solid #e2e8f0;
                                                    border-radius: 12px;
                                                    padding: 3rem 2rem;
                                                    text-align: center;
                                                    margin-top: 2rem;
                                                    position: relative;
                                                    overflow: hidden;
                                                }

                                                .lock-icon {
                                                    font-size: 3rem;
                                                    color: #3b82f6;
                                                    margin-bottom: 1rem;
                                                }

                                                .paywall-content h3 {
                                                    font-size: 1.5rem;
                                                    font-weight: bold;
                                                    margin-bottom: 0.5rem;
                                                    color: #1e293b;
                                                }

                                                .paywall-content p {
                                                    color: #64748b;
                                                    margin-bottom: 2rem;
                                                }

                                                .paywall-actions {
                                                    display: flex;
                                                    flex-direction: column;
                                                    gap: 1rem;
                                                    align-items: center;
                                                    max-width: 400px;
                                                    margin: 0 auto;
                                                }

                                                .btn-purchase {
                                                    width: 100%;
                                                    background: #3b82f6;
                                                    color: white;
                                                    padding: 12px;
                                                    border-radius: 8px;
                                                    font-weight: bold;
                                                    border: none;
                                                    cursor: pointer;
                                                    transition: all 0.2s;
                                                }

                                                .btn-purchase:hover {
                                                    background: #2563eb;
                                                    transform: translateY(-2px);
                                                }

                                                .btn-subscribe-link {
                                                    width: 100%;
                                                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                                                    color: white;
                                                    padding: 12px;
                                                    border-radius: 8px;
                                                    font-weight: bold;
                                                    text-decoration: none;
                                                    display: inline-block;
                                                    transition: all 0.2s;
                                                }

                                                .btn-subscribe-link:hover {
                                                    opacity: 0.9;
                                                    transform: translateY(-2px);
                                                    color: white;
                                                }

                                                .divider {
                                                    display: flex;
                                                    align-items: center;
                                                    color: #94a3b8;
                                                    font-size: 0.9rem;
                                                    width: 100%;
                                                }

                                                .divider::before,
                                                .divider::after {
                                                    content: "";
                                                    flex: 1;
                                                    border-bottom: 1px solid #cbd5e1;
                                                }

                                                .divider::before {
                                                    margin-right: 0.5em;
                                                }

                                                .divider::after {
                                                    margin-left: 0.5em;
                                                }
                                            </style>

                                            <script src="https://js.stripe.com/v3/"></script>
                                            <script>
                                                const stripe = Stripe('<%= stripePublishableKey %>');
                                                const purchaseBtn = document.getElementById('purchase-btn');

                                                if (purchaseBtn) {
                                                    purchaseBtn.addEventListener('click', async () => {
                                                        // ログインチェック
                                                        if (!window.Clerk || !window.Clerk.user) {
                                                            window.Clerk.openSignIn();
                                                            return;
                                                        }

                                                        const articleId = purchaseBtn.dataset.articleId;
                                                        const price = purchaseBtn.dataset.price;
                                                        const title = purchaseBtn.dataset.title;

                                                        purchaseBtn.disabled = true;
                                                        purchaseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 処理中...';

                                                        try {
                                                            const response = await fetch('/api/create-payment', {
                                                                method: 'POST',
                                                                headers: {
                                                                    'Content-Type': 'application/json',
                                                                },
                                                                body: JSON.stringify({
                                                                    articleId,
                                                                    price: parseInt(price),
                                                                    title
                                                                })
                                                            });

                                                            const data = await response.json();

                                                            if (data.error) {
                                                                alert('エラーが発生しました: ' + data.error);
                                                                purchaseBtn.disabled = false;
                                                                purchaseBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> 記事を購入する (¥' + price + ')';
                                                                return;
                                                            }

                                                            window.location.href = data.url;

                                                        } catch (error) {
                                                            console.error('Error:', error);
                                                            alert('通信エラーが発生しました');
                                                            purchaseBtn.disabled = false;
                                                            purchaseBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> 記事を購入する (¥' + price + ')';
                                                        }
                                                    });
                                                }
                                            </script>
                                            <% } %>
                        </div>

                        <div class="article-footer">
                            <!-- <button class="like-button <%= likes.hasLiked ? 'active' : '' %>"
                                onclick="toggleLike('<%= article.id %>')">
                                <i class="<%= likes.hasLiked ? 'fas' : 'far' %> fa-heart"></i>
                                <span>いいね！</span>
                                <span class="like-count">
                                    <%= likes.count %>
                                </span>
                            </button> -->
                            <a href="/articles" class="btn btn-outline">
                                <i class="fas fa-arrow-left"></i> 記事一覧に戻る
                            </a>
                        </div>
                    </article>
            </div>
        </main>

        <%- include('../partials/global-footer', { isHome: false }) %>

            <style>
                .article-container {
                    max-width: 800px;
                    margin: 0 auto;
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                }

                .article-header {
                    margin-bottom: 2rem;
                    border-bottom: 1px solid #e2e8f0;
                    padding-bottom: 1rem;
                }

                .article-title {
                    font-size: 2rem;
                    color: #1e293b;
                    margin-bottom: 0.5rem;
                    text-align: center;
                    /* font-style: italic; */
                }

                .article-meta {
                    color: #64748b;
                    font-size: 0.9rem;
                }

                .article-content {
                    font-size: 16px;
                    line-height: 1.8;
                    color: #334155;
                }

                .article-content p {
                    margin-bottom: 1.5em;
                }

                .article-content h2 {
                    font-weight: bold;
                    margin-top: 2em;
                    margin-bottom: 1em;
                    padding-bottom: 0.5em;
                    border-bottom: 2px solid #e2e8f0;
                }

                .article-content h3 {
                    font-weight: bold;
                    margin-top: 1.5em;
                    margin-bottom: 1em;
                }

                .article-content figure {
                    margin: 1.5em auto;
                    text-align: center;
                }

                .article-content img {
                    max-width: 100%;
                    height: auto;
                    border-radius: 8px;
                    text-align: center;
                }

                .article-content figcaption {
                    font-size: 0.85em;
                    color: #888;
                    margin-top: 0.5em;
                    font-style: italic;
                    text-align: center;
                }

                .article-footer {
                    margin-top: 3rem;
                    border-top: 1px solid #e2e8f0;
                    padding-top: 2rem;
                }

                @media (max-width: 768px) {
                    .article-container {
                        padding: 1.5rem;
                    }

                    .article-title {
                        font-size: 1.5rem;
                    }

                    .article-content {
                        font-size: 16px;
                    }
                }

                @media (max-width: 480px) {
                    .article-container {
                        margin-left: -20px;
                        margin-right: -20px;
                        width: calc(100% + 40px);
                        max-width: none;
                        border-radius: 0;
                        padding: 1.5rem 1rem;
                    }
                }
            </style>

            <script>
                // Clerkの初期化と認証UIの更新
                window.addEventListener('load', async () => {
                    if (window.Clerk && typeof window.Clerk.load === 'function') {
                        await window.Clerk.load();
                        updateAuthUI();
                    }
                });

                function handleUserProfile() {
                    if (window.Clerk && window.Clerk.user) {
                        window.Clerk.openUserProfile();
                    } else {
                        window.Clerk.openSignIn();
                    }
                }

                function updateAuthUI() {
                    const user = window.Clerk.user;
                    const userGreeting = document.getElementById('user-greeting');
                    const loginBtn = document.getElementById('login-btn');

                    if (user) {
                        if (userGreeting) userGreeting.style.display = 'none';
                        if (loginBtn) {
                            loginBtn.innerHTML = '<i class="fas fa-user"></i>';
                            loginBtn.onclick = handleUserProfile;
                        }
                    } else {
                        if (userGreeting) userGreeting.style.display = 'none';
                        if (loginBtn) {
                            loginBtn.innerHTML = '<i class="fas fa-right-to-bracket"></i> ログイン';
                            loginBtn.onclick = () => window.Clerk.openSignIn();
                        }
                    }
                }
            </script>
            <!-- <script>
                async function toggleLike(articleId) {
                    // ログインチェック
                    if (!window.Clerk || !window.Clerk.user) {
                        window.Clerk.openSignIn();
                        return;
                    }

                    // すべてのいいねボタンを取得
                    const buttons = document.querySelectorAll('.like-button');
                    const countSpans = document.querySelectorAll('.like-count');

                    try {
                        const response = await fetch(`/api/articles/${articleId}/like`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.status === 401) {
                            alert('いいねするにはログインが必要です。');
                            return;
                        }

                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }

                        const data = await response.json();

                        // UI更新 (すべてのボタンとカウントを更新)
                        countSpans.forEach(span => {
                            span.textContent = data.count;
                        });

                        buttons.forEach(button => {
                            const icon = button.querySelector('i');
                            if (data.hasLiked) {
                                button.classList.add('active');
                                if (icon) {
                                    icon.classList.remove('far');
                                    icon.classList.add('fas');
                                }
                            } else {
                                button.classList.remove('active');
                                if (icon) {
                                    icon.classList.remove('fas');
                                    icon.classList.add('far');
                                }
                            }
                        });

                    } catch (error) {
                        console.error('Error:', error);
                        alert('エラーが発生しました。');
                    }
                }
            </script> -->
</body>

</html>